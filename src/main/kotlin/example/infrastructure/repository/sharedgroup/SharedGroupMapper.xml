<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="example.infrastructure.repository.sharedgroup.SharedGroupMapper">
    <select id="findOneBySharedGroupId" resultMap="SharedGroupResultEntityResultMap">
        SELECT
            <include refid="AllColumns"/>
        FROM
            shared_groups
            LEFT OUTER JOIN members ON members.shared_group_id = shared_groups.shared_group_id
            LEFT OUTER JOIN invitees ON invitees.shared_group_id = shared_groups.shared_group_id
        WHERE
            shared_groups.shared_group_id = #{sharedGroupId};
    </select>

    <select id="findAllByAccountId" resultMap="SharedGroupResultEntityResultMap">
        SELECT
            <include refid="AllColumns"/>
        FROM
            shared_groups
            LEFT OUTER JOIN members ON members.shared_group_id = shared_groups.shared_group_id
            LEFT OUTER JOIN invitees ON invitees.shared_group_id = shared_groups.shared_group_id
        WHERE
            members.member = #{accountId} OR invitees.invitee = #{accountId};
    </select>

    <insert id="insertOneSharedGroup">
        INSERT INTO shared_groups(
            shared_group_id
        )VALUES(
            #{sharedGroupId}
        );
    </insert>

    <insert id="insertAllMembers">
        INSERT INTO members(
            shared_group_id,
            member
        )VALUES
            <foreach collection="members" item="item" separator=",">
                (#{sharedGroupId}, #{item})
            </foreach>
        ;
    </insert>

    <insert id="insertAllInvitees">
        INSERT INTO invitees(
            shared_group_id,
            invitee
        )VALUES
            <foreach collection="invitees" item="item" separator=",">
                (#{sharedGroupId}, #{item})
            </foreach>
        ;
    </insert>

    <delete id="deleteOneSharedGroup">
        DELETE FROM shared_groups
        WHERE shared_group_id = #{sharedGroupId};
    </delete>

    <delete id="deleteAllMembers">
        DELETE FROM members
        WHERE shared_group_id = #{sharedGroupId};
    </delete>

    <delete id="deleteAllInvitees">
        DELETE FROM invitees
        WHERE shared_group_id = #{sharedGroupId};
    </delete>


    <sql id="AllColumns">
        shared_groups.shared_group_id AS shared_group_id,
        members.member AS member,
        invitees.invitee AS invitee
    </sql>

    <resultMap id="SharedGroupResultEntityResultMap" type="example.infrastructure.repository.sharedgroup.SharedGroupResultEntity">
        <constructor>
            <idArg column="shared_group_id" javaType="SharedGroupId" resultMap="SharedGroupIdResultMap"/>
        </constructor>
        <id column="shared_group_id"/>
        <collection column="member" property="members" ofType="AccountId" resultMap="MemberResultMap"/>
        <collection column="invitee" property="invitees" ofType="AccountId" resultMap="InviteesResultMap"/>
    </resultMap>
    <resultMap id="SharedGroupIdResultMap" type="SharedGroupId">
        <constructor>
            <idArg column="shared_group_id" javaType="String"/>
        </constructor>
    </resultMap>
    <resultMap id="MemberResultMap" type="AccountId">
        <constructor>
            <idArg column="member" javaType="String"/>
        </constructor>
    </resultMap>
    <resultMap id="InviteesResultMap" type="AccountId">
        <constructor>
            <idArg column="invitee" javaType="String"/>
        </constructor>
    </resultMap>
</mapper>